# Requirements Document

## Introduction

本功能为视频生成系统增加角色创建能力。用户可以从已生成的视频中提取角色，创建可复用的角色模板。创建的角色可以在后续视频生成时通过 `@{username}` 的方式引用，实现角色一致性。

系统支持两种角色创建方式：
1. 从已生成的视频任务中提取角色（使用 task_id）
2. 从外部视频 URL 提取角色（使用 video URL）

角色创建使用 sora2 character-training API，该 API 是异步的，需要轮询状态直到训练完成。

## Glossary

- **Character (角色)**: 从视频中提取的人物形象，可在后续视频生成中复用
- **Character Creation System (角色创建系统)**: 负责角色创建和管理的功能模块
- **Sora2 Character Training API**: 第三方 API (api.dyuapi.com)，用于从视频中训练角色
- **Character ID**: API 返回的角色标识符，格式如 `video_ac587076-b36f-4854-ade8-8fdb4e255a48`
- **Custom Name (自定义名称)**: 用户为角色设置的友好名称，用于本地显示和引用
- **Timestamps (时间戳)**: 视频中角色出现的时间范围，格式为 `起始秒,结束秒`，例如 `1,3` 表示视频的第1秒到第3秒。范围差值最小1秒，最大3秒
- **From Task (来源任务)**: 已生成的视频任务 ID，用于从该视频中提取角色
- **Video URL (视频地址)**: 外部视频的下载地址，用于从指定视频中提取角色
- **Training Status (训练状态)**: 角色训练的进度状态，包括 pending、processing、completed、failed

## Requirements

### Requirement 1

**User Story:** As a user, I want to create characters from my generated videos using task ID, so that I can reuse consistent character appearances in future video generations.

#### Acceptance Criteria

1. WHEN a user opens the character creation dialog THEN the Character Creation System SHALL display a form with fields for custom name, description, and video timestamp range
2. WHEN a user enters a custom name THEN the Character Creation System SHALL validate that the name is between 1 and 10 characters
3. WHEN a user enters a description THEN the Character Creation System SHALL validate that the description is between 1 and 500 characters
4. WHEN a user specifies a timestamp range THEN the Character Creation System SHALL validate that the range difference is between 1 and 3 seconds
5. WHEN a user submits the character creation form with a task ID THEN the Character Creation System SHALL call the Sora2 Character Training API with character (task_id), prompt, model="character-training", and timestamps

### Requirement 2

**User Story:** As a user, I want to create characters from external video URLs, so that I can extract characters from videos not generated by this system.

#### Acceptance Criteria

1. WHEN a user provides a video URL instead of task ID THEN the Character Creation System SHALL call the Sora2 Character Training API with url, prompt, model="character-training", and timestamps
2. WHEN the video URL is invalid or inaccessible THEN the Character Creation System SHALL display an appropriate error message
3. WHEN creating a character from URL THEN the Character Creation System SHALL use the same validation rules for timestamps (1-3 seconds range)

### Requirement 3

**User Story:** As a user, I want to track the training progress of my character, so that I know when the character is ready to use.

#### Acceptance Criteria

1. WHEN a character training task is submitted THEN the Character Creation System SHALL store the task with status "pending"
2. WHEN the training is in progress THEN the Character Creation System SHALL poll the API and update the progress percentage
3. WHEN the training completes successfully THEN the Character Creation System SHALL update the status to "completed" and store the character ID
4. IF the training fails THEN the Character Creation System SHALL update the status to "failed" and display the error reason

### Requirement 4

**User Story:** As a user, I want to map API-generated character IDs to my custom names, so that I can easily identify and reference my characters.

#### Acceptance Criteria

1. WHEN the Sora2 API returns a character THEN the Character Creation System SHALL store both the API character ID and the user's custom name
2. WHEN displaying characters THEN the Character Creation System SHALL show the custom name as the primary identifier
3. WHEN a user references a character in a prompt THEN the Character Creation System SHALL convert the custom name to the API character ID format
4. WHEN storing a character THEN the Character Creation System SHALL persist the mapping between custom name and API character ID in the database

### Requirement 5

**User Story:** As a user, I want to view and manage my created characters, so that I can see all available characters and delete ones I no longer need.

#### Acceptance Criteria

1. WHEN the Frontend Application loads THEN the Character Creation System SHALL fetch and display all saved characters
2. WHEN displaying a character THEN the Character Creation System SHALL show the custom name, API character ID, and training status
3. WHEN a user requests to delete a character THEN the Character Creation System SHALL remove the character record from the database
4. WHEN deletion is successful THEN the Frontend Application SHALL remove the character from the displayed list

### Requirement 6

**User Story:** As a developer, I want the character data to be persisted in the database, so that characters are available across application restarts.

#### Acceptance Criteria

1. WHEN the Backend Service starts THEN the Backend Service SHALL create the characters table if it does not exist
2. WHEN storing a character THEN the Backend Service SHALL save id, api_character_id, custom_name, description, source_type (task/url), source_value, timestamps, status, progress, created_at
3. WHEN the Backend Service serializes character records THEN the Backend Service SHALL include all fields with proper JSON tags
4. WHEN the Backend Service deserializes character records THEN the Backend Service SHALL parse JSON and populate the corresponding struct fields
